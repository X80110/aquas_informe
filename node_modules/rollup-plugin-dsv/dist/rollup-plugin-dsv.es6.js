import { extname } from 'path';
import { tsv, csv } from 'd3-dsv';
import toSource from 'tosource';
import { createFilter } from 'rollup-pluginutils';

var parsers = { '.csv': csv, '.tsv': tsv };

function dsv ( options ) {
	if ( options === void 0 ) options = {};

	var filter = createFilter( options.include, options.exclude );

	return {
		name: 'dsv',

		transform: function transform ( code, id ) {
			if ( !filter( id ) ) return null;

			var ext = extname( id );
			if ( !( ext in parsers ) ) return null;

			var rows = parsers[ ext ].parse( code );

			if ( options.processRow ) {
				rows = rows.map( function (row) { return options.processRow( row, id ) || row; } );
			}

			return {
				code: ("export default " + (toSource( rows )) + ";"),
				map: { mappings: '' }
			};
		}
	};
}

export default dsv;